<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Frunk å·¥å…·ç®±</title>

  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="theme-color" content="#00BFFF">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js"></script>

  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <header>
      <div class="logo-title">
        <img src="logo.svg" alt="Frunk Logo" class="logo" onerror="this.style.display='none'">
        <h2>Frunk å·¥å…·ç®±</h2>
      </div>
      <div v-if="user" style="display:flex; gap:10px; align-items:center;">
        <span>å·²ç™»é™†: {{user.email}}</span>
        <button v-if="view !== 'toolbox'" @click="goToolbox">è¿”å›å·¥å…·ç®±</button>
        <button @click="logout">é€€å‡ºç™»é™†</button>
      </div>
    </header>

    <section v-if="!user">
      <h3>ç™»é™†</h3>
      <input v-model="form.email" placeholder="Email">
      <input v-model="form.password" placeholder="Password" type="password">
      <div class="row">
        <button @click="login">ç™»é™†</button>
        <button @click="register">æ³¨å†Œ</button>
      </div>
      <p style="color:#c00" v-if="err">{{err}}</p>
    </section>

    <section v-else-if="view === 'toolbox'">
      <h3 style="margin-top: 0;">å·¥å…·ç®±</h3>
      <p style="color:#666; margin-top:6px;">é€‰æ‹©ä¸€ä¸ªå·¥å…·å¼€å§‹ä½¿ç”¨ã€‚</p>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 14px;">
        <div v-for="t in tools" :key="t.id" class="note" style="cursor:pointer;" @click="openTool(t)">
          <div class="note-header">
            <div class="note-title-section">
              <h4 class="note-title-display">{{t.name}}</h4>
            </div>
          </div>
          <div class="note-content-display" style="color:#666;">
            {{t.description}}
          </div>
        </div>
      </div>
    </section>

    <section v-else-if="view === 'koculator'">
      <h3 style="margin-top: 0;">Koculator è®¡ç®—å™¨</h3>
      <div class="note" style="max-width: 560px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap: 12px;">
          <div>
            <div style="font-size: 12px; color:#666;">è¡¨è¾¾å¼</div>
            <div style="font-size: 22px; font-weight: 600; word-break: break-all;">{{calc.expr || '0'}}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size: 12px; color:#666;">ç»“æœ</div>
            <div style="font-size: 18px; font-weight: 600;" :style="{color: calc.hasError ? '#c00' : '#111'}">
              {{calc.result || '\u00A0'}}
            </div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 14px;">
          <button @click="calcClear">C</button>
          <button @click="calcBackspace">âŒ«</button>
          <button @click="calcAppend('(')">(</button>
          <button @click="calcAppend(')')">)</button>

          <button @click="calcAppend('7')">7</button>
          <button @click="calcAppend('8')">8</button>
          <button @click="calcAppend('9')">9</button>
          <button @click="calcAppend('/')">Ã·</button>

          <button @click="calcAppend('4')">4</button>
          <button @click="calcAppend('5')">5</button>
          <button @click="calcAppend('6')">6</button>
          <button @click="calcAppend('*')">Ã—</button>

          <button @click="calcAppend('1')">1</button>
          <button @click="calcAppend('2')">2</button>
          <button @click="calcAppend('3')">3</button>
          <button @click="calcAppend('-')">âˆ’</button>

          <button @click="calcAppend('0')" style="grid-column: span 2;">0</button>
          <button @click="calcAppend('.')">.</button>
          <button @click="calcAppend('+')">+</button>
        </div>

        <div class="row" style="margin-top: 12px;">
          <button @click="calcEquals" style="flex:1;">=</button>
        </div>
        <small style="color:#999;">é”®ç›˜æ”¯æŒï¼šæ•°å­—ã€+ - * / ( )ã€Enterã€Backspaceã€Esc</small>
      </div>
    </section>

    <section v-else-if="view === 'notes'">
      <!-- ç›´æ¥å¤ç”¨åŸ notes UIï¼ˆä¿æŒåŠŸèƒ½ä¸€è‡´ï¼Œåç»­å†æ‹†æˆç‹¬ç«‹æ–‡ä»¶ï¼‰ -->
      <div class="search-bar">
        <div class="search-container" style="margin-bottom:8px;">
          <input v-model="searchQuery" @keyup.enter="search" placeholder="æœç´¢ç¬”è®°æ ‡é¢˜æˆ–å†…å®¹..." class="search-input" style="width:50%;">
          <button @click="search" class="search-btn">ğŸ” æœç´¢</button>
          <button @click="clearSearch" class="clear-search" v-if="searchQuery || selectedTagId">æ¸…é™¤</button>
          <button @click="showTagManager = !showTagManager" class="clear-search">
            {{showTagManager ? 'éšè—' : 'æ ‡ç­¾ç®¡ç†'}}
          </button>
        </div>

        <div class="filter-tags" v-if="tags.length > 0">
          <span style="font-size:12px; color:#666; margin-right:8px;">ç­›é€‰æ ‡ç­¾:</span>
          <span v-for="tag in tags" :key="tag.id"
            class="tag filter-tag"
            :class="{active: selectedTagId === tag.id}"
            :style="{backgroundColor: tag.color}"
            @click="filterByTag(tag.id)">
            {{tag.name}} ({{tag.note_count}})
          </span>
        </div>
      </div>

      <div v-if="showTagManager" class="tag-manager">
        <h4>æ ‡ç­¾ç®¡ç†</h4>
        <div class="tag-form">
          <input v-model="newTag.name" placeholder="æ ‡ç­¾å" class="tag-input">
          <input v-model="newTag.color" type="color" class="color-input">
          <button @click="createTag" class="clear-search">æ·»åŠ æ ‡ç­¾</button>
        </div>
        <div v-if="tags.length > 0" class="existing-tags">
          <h5>ç°æœ‰æ ‡ç­¾</h5>
          <div v-for="tag in tags" :key="tag.id" class="tag-item">
            <div v-if="!tag.isEditing" class="tag-display">
              <span class="tag tag-in-manager" :style="{backgroundColor: tag.color}">
                {{tag.name}} ({{tag.note_count}})
              </span>
              <div class="tag-actions">
                <button @click="startEditTag(tag)" class="edit-tag-btn" title="ç¼–è¾‘æ ‡ç­¾">âœï¸</button>
                <button @click="deleteTag(tag.id)" class="delete-tag-btn" title="åˆ é™¤æ ‡ç­¾">ğŸ—‘ï¸</button>
              </div>
            </div>

            <div v-else class="tag-edit">
              <input v-model="tag.editName" class="tag-edit-input" placeholder="æ ‡ç­¾å"
                @keyup.enter="saveTagEdit(tag)" @keyup.escape="cancelTagEdit(tag)">
              <input v-model="tag.editColor" type="color" class="tag-edit-color">
              <div class="tag-edit-actions">
                <button @click="saveTagEdit(tag)" class="save-tag-btn" title="ä¿å­˜">âœ…</button>
                <button @click="cancelTagEdit(tag)" class="cancel-tag-btn" title="å–æ¶ˆ">âŒ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="new-memo-section">
        <div v-if="!showNewMemoForm" class="new-memo-collapsed">
          <button @click="expandNewMemoForm" class="add-memo-btn" title="åˆ›å»ºæ–°ç¬”è®°">â• New Memo</button>
        </div>

        <div v-else class="new-memo-expanded">
          <div class="new-memo-header">
            <h3>New Memo</h3>
            <button @click="cancelNewMemo" class="cancel-btn" title="å–æ¶ˆ">âœ–ï¸</button>
          </div>

          <input v-model="draft.title" placeholder="æ ‡é¢˜">
          <div class="rich-editor-container">
            <div id="draft-editor" class="rich-editor"></div>
          </div>

          <div v-if="tags.length > 0" style="margin:8px 0;">
            <small style="color:#666;">é€‰æ‹©æ ‡ç­¾:</small><br>
            <span v-for="tag in tags" :key="tag.id"
              class="tag"
              :class="{selected: draft.tag_ids.includes(tag.id)}"
              :style="{backgroundColor: tag.color, opacity: draft.tag_ids.includes(tag.id) ? 1 : 0.5}"
              @click="toggleTagInDraft(tag.id)">
              {{tag.name}}
            </span>
          </div>

          <div class="new-memo-actions">
            <button @click="createNote" class="save-memo-btn">ğŸ’¾ ä¿å­˜</button>
            <button @click="cancelNewMemo" class="cancel-memo-btn">å–æ¶ˆ</button>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 16px;">
        <div>
          <h3>æˆ‘çš„ç¬”è®°</h3>
          <small v-if="searchQuery || selectedTagId" style="color:#007bff;">
            <span v-if="searchQuery">æœç´¢: "{{searchQuery}}"</span>
            <span v-if="searchQuery && selectedTagId"> + </span>
            <span v-if="selectedTagId">æ ‡ç­¾: "{{tags.find(t => t.id === selectedTagId)?.name}}"</span>
          </small>
        </div>
        <div style="text-align:right;">
          <small style="color:#666;">
            {{searchQuery || selectedTagId ? 'æ‰¾åˆ°' : 'å…±'}} {{pagination.total || notes.length}} æ¡ç¬”è®°
            <span v-if="pagination.pages > 1">(ç¬¬ {{pagination.page}} / {{pagination.pages}} é¡µ)</span>
          </small><br>
          <small style="color:#999; font-size:10px;">å½“å‰æ—¶é—´: {{getCurrentTime()}}</small>
        </div>
      </div>

      <div v-if="notes.length === 0" style="text-align:center; color:#999; padding:40px;">
        <p>è¿˜æ²¡æœ‰ç¬”è®°ï¼Œåˆ›å»ºç¬¬ä¸€æ¡ç¬”è®°å§ï¼</p>
      </div>

      <div class="note" v-for="n in notes" :key="n.id" :class="{updating: n.updating, editing: n.isEditing, pinned: n.is_pinned}">
        <div class="note-header">
          <div class="note-title-section">
            <span v-if="n.is_pinned" class="pin-indicator" title="å·²é¡¶ç½®">ğŸ“Œ</span>
            <input v-if="n.isEditing" class="note-title" v-model="n.title" @input="scheduleUpdate(n)" placeholder="ç¬”è®°æ ‡é¢˜">
            <h4 v-else class="note-title-display" @click="startEdit(n)">{{n.title || 'æ— æ ‡é¢˜'}}</h4>
          </div>

          <div class="note-controls">
            <span class="update-status" v-if="n.updating">ä¿å­˜ä¸­...</span>
            <span class="update-status" v-else-if="n.justSaved">å·²ä¿å­˜</span>

            <button @click="togglePin(n)" class="pin-btn" :class="{active: n.is_pinned}" :title="n.is_pinned ? 'å–æ¶ˆé¡¶ç½®' : 'é¡¶ç½®ç¬”è®°'">ğŸ“Œ</button>
            <button v-if="!n.isEditing" @click="startEdit(n)" class="edit-btn" title="ç¼–è¾‘ç¬”è®°">âœï¸ ç¼–è¾‘</button>
            <button v-else @click="finishEdit(n)" class="save-btn" title="å®Œæˆç¼–è¾‘">âœ… å®Œæˆ</button>
          </div>
        </div>

        <div v-if="n.isEditing" class="rich-editor-container">
          <div :id="'note-editor-' + n.id" class="rich-editor compact"></div>
        </div>
        <div v-else class="note-content-display" @click="startEdit(n)" v-html="n.content"></div>

        <div class="note-tags">
          <div v-if="!n.isEditing && n.tags && n.tags.length > 0" class="selected-tags">
            <small style="color:#666;">æ ‡ç­¾:</small>
            <span v-for="tag in n.tags" :key="tag.id" class="tag tag-readonly" :style="{backgroundColor: tag.color}">
              {{tag.name}}
            </span>
          </div>

          <div v-if="n.isEditing && tags.length > 0" class="editable-tags">
            <small style="color:#666;">é€‰æ‹©æ ‡ç­¾:</small>
            <span v-for="tag in tags" :key="tag.id"
              class="tag tag-selectable"
              :class="{selected: n.tags.some(t => t.id === tag.id)}"
              :style="{backgroundColor: tag.color, opacity: n.tags.some(t => t.id === tag.id) ? 1 : 0.4}"
              @click="toggleTagInNote(n, tag.id)">
              {{tag.name}}
            </span>
          </div>
        </div>

        <div class="note-actions">
          <div class="time-info">
            <span>åˆ›å»º: {{ formatTime(n.created_at) }}</span>
            <span v-if="n.created_at !== n.updated_at">æ›´æ–°: {{ formatTime(n.updated_at) }}</span>
          </div>
          <button class="delete-btn" @click="deleteNote(n.id)" title="åˆ é™¤ç¬”è®°">åˆ é™¤</button>
        </div>
      </div>

      <div v-if="pagination.pages > 1" class="pagination">
        <button @click="goPrev" :disabled="pagination.page <= 1">â† ä¸Šä¸€é¡µ</button>
        <button v-for="p in getPageNumbers()" :key="p" @click="goPage(p)" :class="{active: p === pagination.page}" v-if="p !== '...'">
          {{p}}
        </button>
        <span v-for="p in getPageNumbers()" :key="p" v-if="p === '...'" class="pagination-info">...</span>
        <button @click="goNext" :disabled="pagination.page >= pagination.pages">ä¸‹ä¸€é¡µ â†’</button>
      </div>
    </section>

    <section v-else>
      <p style="color:#c00;">æœªçŸ¥å·¥å…·è§†å›¾ï¼š{{view}}</p>
      <button @click="goToolbox">è¿”å›å·¥å…·ç®±</button>
    </section>
  </div>

  <script src="js/app.js"></script>
  <script src="js/main.js"></script>
</body>
</html>


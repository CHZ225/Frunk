<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Frunk å·¥å…·ç®±</title>

  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="theme-color" content="#1d4ed8">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js"></script>

  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <header>
      <div class="logo-title">
        <img src="logo.svg" alt="Frunk Logo" class="logo" onerror="this.style.display='none'">
        <h2>Frunk å·¥å…·ç®±</h2>
      </div>
      <div v-if="user" style="display:flex; gap:10px; align-items:center; flex-wrap: wrap; justify-content: flex-end;">
        <span>å·²ç™»é™†: {{user.email}}</span>
        <button v-if="view !== 'profile'" @click="goProfile">ä¸ªäººä¸»é¡µ</button>
        <button v-if="user.role === 'admin' && view !== 'admin'" @click="goAdmin">ç®¡ç†å‘˜</button>
        <button v-if="view !== 'toolbox'" @click="goToolbox">è¿”å›å·¥å…·ç®±</button>
        <button @click="logout">é€€å‡ºç™»é™†</button>
      </div>
    </header>

    <section v-if="!user">
      <h3>ç™»é™†</h3>
      <input v-model="form.email" placeholder="Email">
      <div class="password-field">
        <input v-model="form.password" placeholder="Password" :type="showPassword ? 'text' : 'password'">
        <button class="toggle-password" type="button" @click="togglePassword">
          {{showPassword ? 'éšè—' : 'æ˜¾ç¤º'}}
        </button>
      </div>
      <div class="row">
        <button @click="login">ç™»é™†</button>
        <button @click="register">æ³¨å†Œ</button>
      </div>
      <button class="link-btn" @click="openResetModal">å¿˜è®°å¯†ç ï¼Ÿ</button>
      <p style="color:#c00" v-if="err">{{err}}</p>
    </section>

    <section v-if="showResetModal" class="modal-mask">
      <div class="modal-card">
        <div class="modal-header">
          <h4>æ‰¾å›å¯†ç </h4>
          <button class="cancel-btn" @click="closeResetModal">âœ–ï¸</button>
        </div>
        <p style="color:#666; margin-top:6px;">è¾“å…¥é‚®ç®±æäº¤ç”³è¯·ï¼Œç®¡ç†å‘˜ä¼šå¤„ç†ã€‚</p>
        <input v-model="resetEmail" placeholder="é‚®ç®±">
        <div class="row">
          <button @click="submitResetRequest" class="save-btn">æäº¤</button>
          <button @click="closeResetModal" class="cancel-memo-btn">å–æ¶ˆ</button>
        </div>
        <small v-if="resetStatus" style="color:#1f6945;">{{resetStatus}}</small>
      </div>
    </section>

    <section v-else-if="user && view === 'toolbox'">
      <h3 style="margin-top: 0;">å·¥å…·ç®±</h3>
      <p style="color:#666; margin-top:6px;">é€‰æ‹©ä¸€ä¸ªå·¥å…·å¼€å§‹ä½¿ç”¨ã€‚</p>

      <div v-if="announcements.length" class="announcement-board">
        <div class="announcement-header">
          <h4>å…¬å‘Š</h4>
          <small>æœ€æ–°é€šçŸ¥</small>
        </div>
        <div class="announcement-list">
          <div class="announcement-card" v-for="item in announcements" :key="item.id">
            <div class="announcement-title">{{item.title}}</div>
            <div class="announcement-content" v-html="item.content"></div>
            <div class="announcement-time">{{formatTime(item.created_at)}}</div>
          </div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 14px;">
        <div v-for="t in tools" :key="t.id" class="note" style="cursor:pointer;" @click="openTool(t)">
          <div class="note-header">
            <div class="note-title-section">
              <h4 class="note-title-display">{{t.name}}</h4>
            </div>
          </div>
          <div class="note-content-display" style="color:#666;">
            {{t.description}}
          </div>
        </div>
      </div>
    </section>

    <section v-else-if="user && view === 'admin'">
      <div class="admin-header">
        <div>
          <h3 style="margin-top: 0;">ç®¡ç†å‘˜åå°</h3>
          <p style="color:#666; margin-top:6px;">å…¬å‘Šç®¡ç†ä¸ç”¨æˆ·ç®¡ç†ã€‚</p>
        </div>
        <button @click="goToolbox">è¿”å›å·¥å…·ç®±</button>
      </div>

      <p v-if="err" style="color:#c00;">{{err}}</p>

      <div class="admin-grid">
        <div class="admin-card">
          <div class="admin-card-header">
            <h4>å…¬å‘Šç®¡ç†</h4>
            <button @click="toggleAnnouncementForm" class="clear-search">
              {{showAnnouncementForm ? 'æ”¶èµ·' : 'æ–°å»ºå…¬å‘Š'}}
            </button>
          </div>

          <div v-if="showAnnouncementForm" class="admin-form">
            <input v-model="announcementForm.title" placeholder="å…¬å‘Šæ ‡é¢˜">
            <textarea v-model="announcementForm.content" placeholder="å…¬å‘Šå†…å®¹" rows="4"></textarea>
            <div class="admin-form-row">
              <label class="admin-switch">
                <input type="checkbox" v-model="announcementForm.is_active">
                <span>ç«‹å³å‘å¸ƒ</span>
              </label>
              <button @click="saveAnnouncement" class="save-btn">ä¿å­˜</button>
              <button @click="resetAnnouncementForm" class="cancel-memo-btn">æ¸…ç©º</button>
            </div>
          </div>

          <div v-if="adminAnnouncements.length" class="admin-list">
            <div class="admin-item" v-for="a in adminAnnouncements" :key="a.id">
              <div class="admin-item-main">
                <div>
                  <div class="announcement-title">{{a.title}}</div>
                  <div class="announcement-content" v-html="a.content"></div>
                  <small>æ›´æ–°: {{formatTime(a.updated_at)}}</small>
                </div>
                <div class="admin-badges">
                  <span class="status-badge" :class="a.is_active ? 'active' : 'inactive'">
                    {{a.is_active ? 'å·²å‘å¸ƒ' : 'æœªå‘å¸ƒ'}}
                  </span>
                </div>
              </div>
              <div class="admin-item-actions">
                <button @click="editAnnouncement(a)" class="edit-btn">ç¼–è¾‘</button>
                <button @click="toggleAnnouncementStatus(a)" class="clear-search">
                  {{a.is_active ? 'ä¸‹çº¿' : 'ä¸Šçº¿'}}
                </button>
                <button @click="deleteAnnouncement(a)" class="delete-btn">åˆ é™¤</button>
              </div>
            </div>
          </div>
          <div v-else class="empty-state">æš‚æ— å…¬å‘Š</div>
        </div>

        <div class="admin-card">
          <div class="admin-card-header">
            <h4>ç”¨æˆ·ç®¡ç†</h4>
            <button @click="loadAdminUsers" class="clear-search">åˆ·æ–°</button>
          </div>

          <div v-if="adminUsers.length" class="admin-list">
            <div class="admin-item" v-for="u in adminUsers" :key="u.id">
              <div class="admin-item-main">
                <div>
                  <div class="user-email">{{u.email}}</div>
                  <small>åˆ›å»º: {{formatTime(u.created_at)}}</small>
                </div>
                <div class="admin-badges">
                  <span class="role-badge">{{u.role}}</span>
                  <span class="status-badge" :class="u.is_active ? 'active' : 'inactive'">
                    {{u.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}}
                  </span>
                </div>
              </div>
              <div class="admin-item-actions">
                <input v-model="u.newPassword" type="password" placeholder="é‡ç½®å¯†ç " class="admin-input">
                <button @click="resetUserPassword(u)" class="save-btn">é‡ç½®</button>
                <button @click="toggleUserActive(u)" class="delete-btn">
                  {{u.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}}
                </button>
              </div>
            </div>
          </div>
          <div v-else class="empty-state">æš‚æ— ç”¨æˆ·æ•°æ®</div>
        </div>

        <div class="admin-card">
          <div class="admin-card-header">
            <h4>å¯†ç æ‰¾å›ç”³è¯·</h4>
            <button @click="loadResetRequests" class="clear-search">åˆ·æ–°</button>
          </div>
          <div v-if="resetRequests.length" class="admin-list">
            <div class="admin-item" v-for="r in resetRequests" :key="r.id">
              <div class="admin-item-main">
                <div>
                  <div class="user-email">{{r.email}}</div>
                  <small>æäº¤: {{formatTime(r.created_at)}}</small>
                </div>
                <div class="admin-badges">
                  <span class="status-badge" :class="r.status === 'pending' ? 'active' : 'inactive'">
                    {{r.status}}
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div v-else class="empty-state">æš‚æ— æ‰¾å›ç”³è¯·</div>
        </div>
      </div>
    </section>

    <section v-else-if="user && view === 'profile'">
      <div class="admin-header">
        <div>
          <h3 style="margin-top: 0;">ä¸ªäººä¸»é¡µ</h3>
          <p style="color:#666; margin-top:6px;">ç»´æŠ¤ä¸ªäººä¿¡æ¯ä¸å¯†ç è®¾ç½®ã€‚</p>
        </div>
        <button @click="goToolbox">è¿”å›å·¥å…·ç®±</button>
      </div>

      <p v-if="err" style="color:#c00;">{{err}}</p>
      <div class="admin-grid">
        <div class="admin-card">
          <div class="admin-card-header">
            <h4>å¤´åƒ</h4>
          </div>
          <div class="avatar-section">
            <div class="avatar-preview">
              <img v-if="profileForm.avatar_url" :src="profileForm.avatar_url" alt="Avatar">
              <div v-else class="avatar-placeholder">ä¸Šä¼ å¤´åƒ</div>
            </div>
            <input type="file" accept="image/*" @change="uploadAvatar">
            <small style="color:#666;">æ”¯æŒ JPG/PNGï¼Œæœ€å¤§ 2MBã€‚</small>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-header">
            <h4>åŸºæœ¬ä¿¡æ¯</h4>
          </div>
          <div class="admin-form">
            <input v-model="profileForm.display_name" placeholder="æ˜µç§°">
            <input v-model="profileForm.phone" placeholder="æ‰‹æœºå·">
            <textarea v-model="profileForm.bio" rows="4" placeholder="ä¸ªäººç®€ä»‹"></textarea>
            <div class="admin-form-row">
              <button @click="saveProfile" class="save-btn">ä¿å­˜ä¿¡æ¯</button>
            </div>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-header">
            <h4>ä¿®æ”¹é‚®ç®±</h4>
          </div>
          <div class="admin-form">
            <input v-model="emailForm.email" placeholder="æ–°é‚®ç®±">
            <input v-model="emailForm.current" type="password" placeholder="å½“å‰å¯†ç ">
            <div class="admin-form-row">
              <button @click="changeEmail" class="save-btn">æ›´æ–°é‚®ç®±</button>
            </div>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-header">
            <h4>ä¿®æ”¹å¯†ç </h4>
          </div>
          <div class="admin-form">
            <input v-model="passwordForm.current" type="password" placeholder="å½“å‰å¯†ç ">
            <input v-model="passwordForm.next" type="password" placeholder="æ–°å¯†ç ">
            <div class="admin-form-row">
              <button @click="changePassword" class="save-btn">æ›´æ–°å¯†ç </button>
            </div>
            <small v-if="passwordStatus" style="color:#1f6945;">{{passwordStatus}}</small>
          </div>
        </div>
      </div>
    </section>

    <section v-else-if="user && view === 'koculator'">
      <h3 style="margin-top: 0;">Koculator è®¡ç®—å™¨</h3>
      <div class="note" style="max-width: 560px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap: 12px;">
          <div>
            <div style="font-size: 12px; color:#666;">è¡¨è¾¾å¼</div>
            <div style="font-size: 22px; font-weight: 600; word-break: break-all;">{{calc.expr || '0'}}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size: 12px; color:#666;">ç»“æœ</div>
            <div style="font-size: 18px; font-weight: 600;" :style="{color: calc.hasError ? '#c00' : '#111'}">
              {{calc.result || '\u00A0'}}
            </div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 14px;">
          <button @click="calcClear">C</button>
          <button @click="calcBackspace">âŒ«</button>
          <button @click="calcAppend('(')">(</button>
          <button @click="calcAppend(')')">)</button>

          <button @click="calcAppend('7')">7</button>
          <button @click="calcAppend('8')">8</button>
          <button @click="calcAppend('9')">9</button>
          <button @click="calcAppend('/')">Ã·</button>

          <button @click="calcAppend('4')">4</button>
          <button @click="calcAppend('5')">5</button>
          <button @click="calcAppend('6')">6</button>
          <button @click="calcAppend('*')">Ã—</button>

          <button @click="calcAppend('1')">1</button>
          <button @click="calcAppend('2')">2</button>
          <button @click="calcAppend('3')">3</button>
          <button @click="calcAppend('-')">âˆ’</button>

          <button @click="calcAppend('0')" style="grid-column: span 2;">0</button>
          <button @click="calcAppend('.')">.</button>
          <button @click="calcAppend('+')">+</button>
        </div>

        <div class="row" style="margin-top: 12px;">
          <button @click="calcEquals" style="flex:1;">=</button>
        </div>
        <small style="color:#999;">é”®ç›˜æ”¯æŒï¼šæ•°å­—ã€+ - * / ( )ã€Enterã€Backspaceã€Esc</small>
      </div>
    </section>

    <section v-else-if="user && view === 'notes'">
      <!-- ç›´æ¥å¤ç”¨åŸ notes UIï¼ˆä¿æŒåŠŸèƒ½ä¸€è‡´ï¼Œåç»­å†æ‹†æˆç‹¬ç«‹æ–‡ä»¶ï¼‰ -->
      <div class="search-bar">
        <div class="search-container" style="margin-bottom:8px;">
          <input v-model="searchQuery" @keyup.enter="search" placeholder="æœç´¢ç¬”è®°æ ‡é¢˜æˆ–å†…å®¹..." class="search-input" style="width:50%;">
          <button @click="search" class="search-btn">ğŸ” æœç´¢</button>
          <button @click="clearSearch" class="clear-search" v-if="searchQuery || selectedTagId">æ¸…é™¤</button>
          <button @click="showTagManager = !showTagManager" class="clear-search">
            {{showTagManager ? 'éšè—' : 'æ ‡ç­¾ç®¡ç†'}}
          </button>
        </div>

        <div class="filter-tags" v-if="tags.length > 0">
          <span style="font-size:12px; color:#666; margin-right:8px;">ç­›é€‰æ ‡ç­¾:</span>
          <span v-for="tag in tags" :key="tag.id"
            class="tag filter-tag"
            :class="{active: selectedTagId === tag.id}"
            :style="{backgroundColor: tag.color}"
            @click="filterByTag(tag.id)">
            {{tag.name}} ({{tag.note_count}})
          </span>
        </div>
      </div>

      <div v-if="showTagManager" class="tag-manager">
        <h4>æ ‡ç­¾ç®¡ç†</h4>
        <div class="tag-form">
          <input v-model="newTag.name" placeholder="æ ‡ç­¾å" class="tag-input">
          <input v-model="newTag.color" type="color" class="color-input">
          <button @click="createTag" class="clear-search">æ·»åŠ æ ‡ç­¾</button>
        </div>
        <div v-if="tags.length > 0" class="existing-tags">
          <h5>ç°æœ‰æ ‡ç­¾</h5>
          <div v-for="tag in tags" :key="tag.id" class="tag-item">
            <div v-if="!tag.isEditing" class="tag-display">
              <span class="tag tag-in-manager" :style="{backgroundColor: tag.color}">
                {{tag.name}} ({{tag.note_count}})
              </span>
              <div class="tag-actions">
                <button @click="startEditTag(tag)" class="edit-tag-btn" title="ç¼–è¾‘æ ‡ç­¾">âœï¸</button>
                <button @click="deleteTag(tag.id)" class="delete-tag-btn" title="åˆ é™¤æ ‡ç­¾">ğŸ—‘ï¸</button>
              </div>
            </div>

            <div v-else class="tag-edit">
              <input v-model="tag.editName" class="tag-edit-input" placeholder="æ ‡ç­¾å"
                @keyup.enter="saveTagEdit(tag)" @keyup.escape="cancelTagEdit(tag)">
              <input v-model="tag.editColor" type="color" class="tag-edit-color">
              <div class="tag-edit-actions">
                <button @click="saveTagEdit(tag)" class="save-tag-btn" title="ä¿å­˜">âœ…</button>
                <button @click="cancelTagEdit(tag)" class="cancel-tag-btn" title="å–æ¶ˆ">âŒ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="new-memo-section">
        <div v-if="!showNewMemoForm" class="new-memo-collapsed">
          <button @click="expandNewMemoForm" class="add-memo-btn" title="åˆ›å»ºæ–°ç¬”è®°">â• New Memo</button>
        </div>

        <div v-else class="new-memo-expanded">
          <div class="new-memo-header">
            <h3>New Memo</h3>
            <button @click="cancelNewMemo" class="cancel-btn" title="å–æ¶ˆ">âœ–ï¸</button>
          </div>

          <input v-model="draft.title" placeholder="æ ‡é¢˜">
          <div class="rich-editor-container">
            <div id="draft-editor" class="rich-editor"></div>
          </div>

          <div v-if="tags.length > 0" style="margin:8px 0;">
            <small style="color:#666;">é€‰æ‹©æ ‡ç­¾:</small><br>
            <span v-for="tag in tags" :key="tag.id"
              class="tag"
              :class="{selected: draft.tag_ids.includes(tag.id)}"
              :style="{backgroundColor: tag.color, opacity: draft.tag_ids.includes(tag.id) ? 1 : 0.5}"
              @click="toggleTagInDraft(tag.id)">
              {{tag.name}}
            </span>
          </div>

          <div class="new-memo-actions">
            <button @click="createNote" class="save-memo-btn">ğŸ’¾ ä¿å­˜</button>
            <button @click="cancelNewMemo" class="cancel-memo-btn">å–æ¶ˆ</button>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 16px;">
        <div>
          <h3>æˆ‘çš„ç¬”è®°</h3>
          <small v-if="searchQuery || selectedTagId" style="color:#007bff;">
            <span v-if="searchQuery">æœç´¢: "{{searchQuery}}"</span>
            <span v-if="searchQuery && selectedTagId"> + </span>
            <span v-if="selectedTagId">æ ‡ç­¾: "{{tags.find(t => t.id === selectedTagId)?.name}}"</span>
          </small>
        </div>
        <div style="text-align:right;">
          <small style="color:#666;">
            {{searchQuery || selectedTagId ? 'æ‰¾åˆ°' : 'å…±'}} {{pagination.total || notes.length}} æ¡ç¬”è®°
            <span v-if="pagination.pages > 1">(ç¬¬ {{pagination.page}} / {{pagination.pages}} é¡µ)</span>
          </small><br>
          <small style="color:#999; font-size:10px;">å½“å‰æ—¶é—´: {{getCurrentTime()}}</small>
        </div>
      </div>

      <div v-if="notes.length === 0" style="text-align:center; color:#999; padding:40px;">
        <p>è¿˜æ²¡æœ‰ç¬”è®°ï¼Œåˆ›å»ºç¬¬ä¸€æ¡ç¬”è®°å§ï¼</p>
      </div>

      <div class="note" v-for="n in notes" :key="n.id" :class="{updating: n.updating, editing: n.isEditing, pinned: n.is_pinned}">
        <div class="note-header">
          <div class="note-title-section">
            <span v-if="n.is_pinned" class="pin-indicator" title="å·²é¡¶ç½®">ğŸ“Œ</span>
            <input v-if="n.isEditing" class="note-title" v-model="n.title" @input="scheduleUpdate(n)" placeholder="ç¬”è®°æ ‡é¢˜">
            <h4 v-else class="note-title-display" @click="startEdit(n)">{{n.title || 'æ— æ ‡é¢˜'}}</h4>
          </div>

          <div class="note-controls">
            <span class="update-status" v-if="n.updating">ä¿å­˜ä¸­...</span>
            <span class="update-status" v-else-if="n.justSaved">å·²ä¿å­˜</span>

            <button @click="togglePin(n)" class="pin-btn" :class="{active: n.is_pinned}" :title="n.is_pinned ? 'å–æ¶ˆé¡¶ç½®' : 'é¡¶ç½®ç¬”è®°'">ğŸ“Œ</button>
            <button v-if="!n.isEditing" @click="startEdit(n)" class="edit-btn" title="ç¼–è¾‘ç¬”è®°">âœï¸ ç¼–è¾‘</button>
            <button v-else @click="finishEdit(n)" class="save-btn" title="å®Œæˆç¼–è¾‘">âœ… å®Œæˆ</button>
          </div>
        </div>

        <div v-if="n.isEditing" class="rich-editor-container">
          <div :id="'note-editor-' + n.id" class="rich-editor compact"></div>
        </div>
        <div v-else class="note-content-display" @click="startEdit(n)" v-html="n.content"></div>

        <div class="note-tags">
          <div v-if="!n.isEditing && n.tags && n.tags.length > 0" class="selected-tags">
            <small style="color:#666;">æ ‡ç­¾:</small>
            <span v-for="tag in n.tags" :key="tag.id" class="tag tag-readonly" :style="{backgroundColor: tag.color}">
              {{tag.name}}
            </span>
          </div>

          <div v-if="n.isEditing && tags.length > 0" class="editable-tags">
            <small style="color:#666;">é€‰æ‹©æ ‡ç­¾:</small>
            <span v-for="tag in tags" :key="tag.id"
              class="tag tag-selectable"
              :class="{selected: n.tags.some(t => t.id === tag.id)}"
              :style="{backgroundColor: tag.color, opacity: n.tags.some(t => t.id === tag.id) ? 1 : 0.4}"
              @click="toggleTagInNote(n, tag.id)">
              {{tag.name}}
            </span>
          </div>
        </div>

        <div class="note-actions">
          <div class="time-info">
            <span>åˆ›å»º: {{ formatTime(n.created_at) }}</span>
            <span v-if="n.created_at !== n.updated_at">æ›´æ–°: {{ formatTime(n.updated_at) }}</span>
          </div>
          <button class="delete-btn" @click="deleteNote(n.id)" title="åˆ é™¤ç¬”è®°">åˆ é™¤</button>
        </div>
      </div>

      <div v-if="pagination.pages > 1" class="pagination">
        <button @click="goPrev" :disabled="pagination.page <= 1">â† ä¸Šä¸€é¡µ</button>
        <button v-for="p in getPageNumbers()" :key="p" @click="goPage(p)" :class="{active: p === pagination.page}" v-if="p !== '...'">
          {{p}}
        </button>
        <span v-for="p in getPageNumbers()" :key="p" v-if="p === '...'" class="pagination-info">...</span>
        <button @click="goNext" :disabled="pagination.page >= pagination.pages">ä¸‹ä¸€é¡µ â†’</button>
      </div>
    </section>

    <section v-else-if="user">
      <p style="color:#c00;">æœªçŸ¥å·¥å…·è§†å›¾ï¼š{{view}}</p>
      <button @click="goToolbox">è¿”å›å·¥å…·ç®±</button>
    </section>
  </div>

  <script src="js/app.js"></script>
  <script src="js/main.js"></script>
</body>
</html>
